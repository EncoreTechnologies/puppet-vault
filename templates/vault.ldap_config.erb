#!/bin/bash

if ! grep -q '<%= scope['vault::bin_dir'] -%>' <<< "$PATH" ; then
  export PATH="$PATH:<%= scope['vault::bin_dir'] -%>"
fi

if [[ -z $VAULT_ADDR ]]; then
  export VAULT_ADDR='<%= scope['vault::vault_address'] -%>'
fi

vault write auth/ldap/config \
  url='<%= scope['vault::ldap::config::_ldap_url'] -%>' \
  starttls=<%= scope['vault::ldap::config::starttls'] -%> \
  insecure_tls='<%= scope['vault::ldap::config::insecure_tls'] -%>' \
  certificate=@<%= scope['vault::ldap::config::_ca_cert'] -%> \
  binddn='<%= scope['vault::ldap::config::bind_dn'] -%>' \
  bindpass='<%= scope['vault::ldap::config::bind_passwd'] -%>' \
  userdn='<%= scope['vault::ldap::config::user_dn'] -%>' \
  userattr='<%= scope['vault::ldap::config::user_attr'] -%>' \
  groupdn='<%= scope['vault::ldap::config::group_dn'] -%>' \
  groupattr='<%= scope['vault::ldap::config::group_attr'] -%>' \
  groupfilter='(&(objectClass=group)(member:1.2.840.113556.1.4.1941:={{.UserDN}}))'

